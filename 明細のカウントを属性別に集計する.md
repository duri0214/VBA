# 明細のカウントを属性別に集計する
B27にヘッダーから貼り付け

| MK | ステータス | 当日 |
|--------|:----------:|-----:|
| 1000 | A | 0 |
| 1000 | B | 0 |
| 1000 | C | 0 |
| 1000 | 合計 | 0 |
| 1010 | A | 0 |
| 1010 | B | 0 |
| 1010 | C | 0 |
| 1010 | 合計 | 0 |
| 1020 | A | 0 |
| 1020 | B | 0 |
| 1020 | C | 0 |
| 1020 | 合計 | 0 |
| 1030 | A | 0 |
| 1030 | B | 0 |
| 1030 | C | 0 |
| 1030 | 合計 | 0 |
| その他 | A | 0 |
| その他 | B | 0 |
| その他 | C | 0 |
| その他 | 合計 | 0 |

J27にヘッダーから貼り付け  
・MKとSTATUSでソート  
・特定のMKをその他に置換  
・カウント集計用の1の列を追加  

| MK | ステータス | dammy |
|------|:----------:|------:|
| 1000 | A | 1 |
| 1000 | B | 1 |
| 1000 | B | 1 |
| 1000 | B | 1 |
| 1000 | B | 1 |
| 1000 | C | 1 |
| 1000 | C | 1 |
| 1010 | A | 1 |
| 1010 | B | 1 |
| 1010 | C | 1 |
| 1010 | C | 1 |
| 1010 | C | 1 |
| 1010 | C | 1 |
| 1010 | C | 1 |
| 9999 | A | 1 |
| 9999 | A | 1 |
| 9999 | A | 1 |
| 9999 | A | 1 |
| 9999 | B | 1 |
| 9999 | C | 1 |
| 9999 | C | 1 |
| 1020 | A | 1 |
| 1020 | A | 1 |
| 1020 | A | 1 |
| 1020 | A | 1 |
| 1020 | B | 1 |
| 1020 | C | 1 |
| 1020 | C | 1 |
| 1030 | A | 1 |
| 1030 | B | 1 |
| 1030 | C | 1 |
| 1030 | C | 1 |
| 1030 | C | 1 |
| 1030 | C | 1 |
| 1030 | C | 1 |
| 1030 | C | 1 |

```
Private Sub btnAggCount_Click()
    
    Dim r As Range
    Dim aggheader As Range
    
    Dim i As Integer
    
    Set r = ActiveSheet.Range("J28").Resize(, 2)
    Set r = ActiveSheet.Range(r, r.End(xlDown))
    
    '特定のMKをその他セグメントに変換
    r.Replace "9999", "その他"
    
    Set aggheader = ActiveSheet.Range("B27").Resize(, 3)
    Set r = ActiveSheet.Range("B28").Resize(, 3)
    Set r = ActiveSheet.Range(r, r.End(xlDown))
    
    Dim sum_target As String
    Dim condition1 As String
    Dim condition2 As String
    Dim condition1_value As String
    Dim condition2_value As String
    Dim sumifs_text As String
    For i = 1 To r.Rows.Count
        
        sum_target = "$L$28:$L$63"
        condition1 = "$J$28:$J$63"
        condition1_value = Replace("B{0}", "{0}", r(i, 1).row)
        condition2 = "$K$28:$K$63"
        condition2_value = Replace("C{0}", "{0}", r(i, 1).row)
        
        If r(i, 2).value = "合計" Then
            sumifs_text = "=SUMIFS({SUM_TARGET},{CONDITION1},{CONDITION1_VALUE})"
            sumifs_text = Replace(sumifs_text, "{SUM_TARGET}", sum_target)
            sumifs_text = Replace(sumifs_text, "{CONDITION1}", condition1)
            sumifs_text = Replace(sumifs_text, "{CONDITION1_VALUE}", condition1_value)
        Else
            sumifs_text = "=SUMIFS({SUM_TARGET},{CONDITION1},{CONDITION1_VALUE},{CONDITION2},{CONDITION2_VALUE})"
            sumifs_text = Replace(sumifs_text, "{SUM_TARGET}", sum_target)
            sumifs_text = Replace(sumifs_text, "{CONDITION1}", condition1)
            sumifs_text = Replace(sumifs_text, "{CONDITION1_VALUE}", condition1_value)
            sumifs_text = Replace(sumifs_text, "{CONDITION2}", condition2)
            sumifs_text = Replace(sumifs_text, "{CONDITION2_VALUE}", condition2_value)
        End If
        
        r(i, 3).Formula = sumifs_text
        
    Next i   
    
End Sub
```
```
Private Sub btnReset_Click()

    Dim r As Range
    
    Set r = ActiveSheet.Range("J28").Resize(, 2)
    Set r = ActiveSheet.Range(r, r.End(xlDown))
    r.Replace "その他", "9999"

    Set r = ActiveSheet.Range("D28")
    Set r = ActiveSheet.Range(r, r.End(xlDown))
    r.value = 0

End Sub
```
